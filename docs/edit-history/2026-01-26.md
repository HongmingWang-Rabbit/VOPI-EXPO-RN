# Edit History - January 26, 2026

## Summary

Comprehensive code review fixes addressing 37 issues (5 critical, 12 warnings, 20 suggestions) plus accessibility improvements and test coverage expansion.

---

## Critical Fixes

### 1. S3 Upload Retry Logic
**File:** `src/services/vopi.service.ts`

- Added 3 retries with exponential backoff for S3 uploads
- Added file validation to reject empty or corrupted files (< 1KB)
- Network errors now properly detected and retried

### 2. Logout Error Handling
**File:** `src/contexts/AuthContext.tsx`

- Fixed unhandled promise rejection in `signOut()`
- Properly awaits fetch with try/catch
- Local logout proceeds even if server request fails

### 3. Credit Refresh Race Condition
**File:** `app/(tabs)/settings.tsx`

- Replaced hardcoded `setTimeout(refresh, 2000)` with AppState listener
- Credits now refresh when app returns to foreground after checkout

### 4. Improved Error Messages
**File:** `app/(tabs)/capture.tsx`

- Added specific error messages for permission, camera busy, and storage issues
- Added `MAX_RECORDING_DURATION` constant (60 seconds)

---

## Warning Fixes

### Polling Error Handling
**File:** `src/hooks/useVOPIUpload.ts`

- Added consecutive error tracking (max 5 before stopping)
- Errors now logged in development mode
- Added `UI_STRINGS` constant for i18n readiness

### Network Error Detection
**File:** `src/services/api.client.ts`

- Added robust `isNetworkError()` method
- Detects errors by type, name, and message patterns
- Handles: TypeError, NetworkError, FetchError, connection failures

### OAuth Callback
**File:** `app/oauth/callback.tsx`

- Changed from `window.location.href` to `router.replace('/(tabs)')`
- Stays in app context instead of forcing page reload

### Color Constants
**File:** `src/theme/colors.ts`

- Added `errorLight: '#FFF5F5'`
- Added `successLight: '#E8F8EC'`
- Added `warningLight: '#FFF8E6'`

### Settings Hardcoded Color
**File:** `app/(tabs)/settings.tsx`

- Changed hardcoded `#fff5f5` to `colors.errorLight`

### Safe Date Parsing
**File:** `app/(tabs)/products.tsx`

- Added `formatDate()` utility with fallback for invalid dates

---

## Accessibility Fixes

### Recording Button (`capture.tsx`)
- Added visible text label (REC/STOP) below button
- Added `accessibilityHint` for screen readers

### Camera Flip Button (`capture.tsx`)
- Improved disabled state visibility
- Better accessibility label when disabled

### Products List (`products.tsx`)
- Uses job number and full date instead of truncated ID
- Added `accessibilityHint` for navigation context

---

## Code Cleanup

### Removed Unused Files
- Deleted `src/stores/uploadStore.ts`
- Deleted `src/stores/captureStore.ts`
- Removed empty `src/stores/` directory

---

## New Test Files

| File | Coverage |
|------|----------|
| `src/__tests__/api.client.test.ts` | Retry logic, timeout, headers, error handling |
| `src/__tests__/vopi.service.test.ts` | All API methods, upload validation |
| `src/__tests__/useVOPIUpload.test.ts` | Upload states, polling, cancellation |
| `src/__tests__/AuthContext.test.tsx` | Auth state, signOut, token refresh |

---

## New Constants

### `src/constants/storage.ts`
```typescript
export const STORAGE_KEYS = {
  ACCESS_TOKEN: 'vopi_access_token',
  REFRESH_TOKEN: 'vopi_refresh_token',
  USER: 'vopi_user',
  OAUTH_STATE: 'oauth_state',
  OAUTH_CODE_VERIFIER: 'oauth_code_verifier',
  OAUTH_PROVIDER: 'oauth_provider',
} as const;
```

### `src/config/env.ts`
Environment configuration loaded from `app.json` extra config.

---

## Files Modified

### Source Files
- `src/services/vopi.service.ts` - Upload retry, file validation
- `src/services/api.client.ts` - Network error detection
- `src/contexts/AuthContext.tsx` - Logout fix, JWT type safety
- `src/hooks/useVOPIUpload.ts` - Polling error handling, UI strings
- `src/hooks/useCredits.ts` - State management
- `src/utils/storage.ts` - Session/local storage split
- `src/theme/colors.ts` - New color constants
- `src/components/ui/UploadProgress.tsx` - Progress normalization

### App Files
- `app/(tabs)/settings.tsx` - Credit refresh, color constant
- `app/(tabs)/capture.tsx` - Error messages, accessibility
- `app/(tabs)/products.tsx` - Date parsing, accessibility
- `app/oauth/callback.tsx` - Router navigation

### New Files
- `src/config/env.ts`
- `src/constants/storage.ts`
- `src/__tests__/api.client.test.ts`
- `src/__tests__/vopi.service.test.ts`
- `src/__tests__/useVOPIUpload.test.ts`
- `src/__tests__/AuthContext.test.tsx`

### Deleted Files
- `src/stores/uploadStore.ts`
- `src/stores/captureStore.ts`
