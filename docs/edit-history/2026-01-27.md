# Edit History - January 27, 2026

## Summary

Product redesign (Products tab + Results screen), new API endpoints (cancel/delete jobs, delete images), backend metadata serialization fix, auth token refresh optimization, and two rounds of code review fixes.

---

## Product Redesign

### New Component: `src/components/product/EditableField.tsx`
- Inline-editable text field with edit/save/cancel controls
- Supports text, multiline, array (newline-separated), and number modes
- Number validation with error display
- Wrapped in `React.memo` for render optimization
- Full accessibility labels and hints
- Trims input on save and syncs draft state

### New Component: `src/components/product/FlatImageGallery.tsx`
- Flat 2-column grid of all commercial images (no variant/frame grouping)
- Full-screen modal with pinch-to-zoom via ScrollView
- Download button with URL validation before `Linking.openURL`
- `getItemLayout` for scroll performance optimization
- `useSafeAreaInsets()` for modal header positioning
- URL validation via `new URL()` parsing
- Wrapped in `React.memo`

### Rewritten: `app/results.tsx` (Product Detail Screen)
- Header shows product title from metadata (fallback to Job ID)
- `FlatImageGallery` for all commercial images
- 11 `EditableField` instances for product metadata (title, description, brand, category, etc.)
- Each field saves independently via `vopiService.updateProductMetadata`
- Uses `Promise.allSettled` so URLs/metadata failures don't block each other
- Save error alerts include field name for context

### Rewritten: `app/(tabs)/products.tsx` (Products List Tab)
- Card-based layout with 72x72 thumbnails and product titles from metadata
- Lazy enrichment: fetches download URLs + metadata for completed jobs in batches
- `enrichInBatches()` with `AbortController` for cancellation on re-render
- Concurrency-limited batching (`ENRICH_CONCURRENCY = 5`)
- Bounded enrichment cache (`MAX_ENRICHED_CACHE = 200`) with LRU-style eviction
- Status badges, progress bars, polling for processing jobs
- Pull-to-refresh clears cache and re-enriches

### Deleted: `src/components/product/ResultsGallery.tsx`
- Removed unused component replaced by `FlatImageGallery`

---

## New API Endpoints

### `src/services/vopi.service.ts`
- `cancelJob(jobId)` — Changed from `DELETE` to `POST /api/v1/jobs/:id/cancel`
- `deleteJob(jobId)` — New: `DELETE /api/v1/jobs/:id` (full job deletion)
- `deleteJobImage(jobId, frameId, version)` — New: `DELETE /api/v1/jobs/:id/images/:frameId/:version`
- `getPresignedUrl` — Simplified to one-liner (removed verbose `__DEV__` logging for consistency)

### `src/services/api.client.ts`
- `handleResponse` now handles 204 No Content (returns `undefined` instead of parsing empty JSON)

---

## Auth Improvements

### `src/contexts/AuthContext.tsx`
- **Proactive token refresh on startup**: `loadStoredAuth` now checks JWT `exp` claim before calling `fetchUserProfile`. If token is expired or within 1-minute buffer, refreshes proactively — avoids wasted 401 round-trip
- Fallback error-path refresh retained for edge cases (server-side revocation)

---

## Backend Fix (VOPI repo)

### `/Users/hongming/Documents/GitHub/VOPI/src/routes/jobs.routes.ts`
- Added `additionalProperties: true` to all bare `{ type: 'object' }` in Fastify response schemas
- Without this, `fast-json-stringify` strips nested properties from objects, causing metadata to appear empty in the app
- Affected endpoints: POST /jobs, GET /jobs, GET /jobs/:id, GET /jobs/:id/status, DELETE /jobs/:id/images, GET/PATCH /jobs/:id/metadata, GET /jobs/:id/download-urls

---

## Bug Fixes

### `src/utils/strings.ts`
- `formatDuration` now handles hours: returns `H:MM:SS` for >= 3600s, `M:SS` otherwise

### `src/theme/colors.ts`
- Added `overlayDark: 'rgba(0, 0, 0, 0.95)'` for modal backdrops

### `package.json`
- Fixed Jest `transformIgnorePatterns` for pnpm's `.pnpm/` directory structure
- Uses `expo[^/]*` to match all expo-prefixed packages

---

## Code Review Fixes (Two Rounds)

### Round 1
- URL validation in `FlatImageGallery` before `Linking.openURL`
- Fixed floating promise in products enrichment
- Replaced hardcoded `paddingTop: 60` with `useSafeAreaInsets()`
- Added concurrency limiting on enrichment batches
- Added number validation on price field in `EditableField`
- Replaced index-based keys with composite keys in FlatList
- Extracted inline styles to StyleSheet
- Wrapped components in `React.memo`
- Added accessibility labels throughout
- Deleted dead code (`ResultsGallery.tsx`)

### Round 2
- Replaced `cancelled` boolean with `AbortController` for enrichment race condition
- `Promise.allSettled` in results.tsx for independent failure handling
- Save error alerts include field name
- Bounded enrichment cache with eviction
- `getItemLayout` for FlatList scroll performance
- Trimmed draft sync in `EditableField`
- Consistent logging style in vopi.service.ts

---

## Test Results

- **7 suites, 90 tests, all passing**
- New tests for `cancelJob`, `deleteJob`, `deleteJobImage` endpoints

---

## Files Modified

### New Files
- `src/components/product/EditableField.tsx`
- `src/components/product/FlatImageGallery.tsx`
- `docs/edit-history/2026-01-27.md`

### Modified Files
- `app/results.tsx` — Full rewrite
- `app/(tabs)/products.tsx` — Full rewrite
- `src/services/vopi.service.ts` — New endpoints, simplified getPresignedUrl
- `src/services/api.client.ts` — 204 No Content handling
- `src/contexts/AuthContext.tsx` — Proactive token refresh
- `src/utils/strings.ts` — formatDuration hours fix
- `src/theme/colors.ts` — overlayDark color
- `package.json` — Jest transformIgnorePatterns fix
- `src/__tests__/vopi.service.test.ts` — New endpoint tests

### Deleted Files
- `src/components/product/ResultsGallery.tsx`
